"use strict";function createCartogram(){d3.select("#vizcontain").selectAll("*").remove(),d3.select("#legendcontain").selectAll("*").remove(),function(){var t=d3.scaleOrdinal().domain(["Pakistan Tehreek-e-Insaf","Pakistan Muslim League (N)","Pakistan Peoples Party Parliamentarians","Jamiat Ulama-e-Islam (F)","Independent","Awami National Party","Muttahida Qaumi Movement Pakistan"]).range(["#9C27B0","#81C784","#607D8B","#4DB6AC","#CDDC39","#03A9F4","#BDBDBD"]),e=d3.select("body").select("#vizcontain"),a=1e3,r=600,n=d3.geoMercator().center([75,31.5]).scale([1950]),s=d3.geoPath().projection(n),l=e.append("svg").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 636 600").style("fill-opacity",1).classed("map_in_a_box","true").attr("id","cartogram"),o=l.append("g").classed("map_group","true");function i(t){return t.split(" ").join("")}d3.queue().defer(d3.json,"pakistan_districts.topojson").defer(d3.json,"JAndKashmir.topojson").defer(d3.json,"Pakistan_NationalBoundary.topojson").defer(d3.json,"Pak_prov.topojson").defer(d3.csv,"NA_seats_2013.csv").await(function(e,n,c,d,p,u){var y=topojson.feature(n,n.objects.pakistan_districts).features,f=topojson.feature(c,c.objects.JAndKashmir).features,h=topojson.feature(d,d.objects.Pakistan_NationalBoundary).features,v=topojson.feature(p,p.objects.Pak_prov).features,m=y.map(function(t){var e=t.properties.districts,a={};return a.district=e,a.centroid=s.centroid(t),a});o.append("g").classed("pakDistricts",!0).selectAll("path").data(y).enter().append("path").attr("d",function(t,e){return s(t)}).style("stroke","white").style("stroke-width",.2).style("fill","#FFF").style("fill-opacity",.9).attr("class",function(t,e){return i(t.properties.districts)}).classed("district",!0),o.append("g").classed("JKashmir",!0).selectAll(".Kashmir").data(f).enter().append("path").classed("Kashmir",!0).attr("d",function(t,e){return s(t)}).style("fill-opacity",1).style("stroke","grey").style("stroke-dasharray",2).style("stroke-width",.5).style("fill","#FFF"),o.append("g").classed("Pak_boundary",!0).selectAll(".Pak_boundary").data(h).enter().append("path").classed("Pakistan",!0).attr("d",function(t,e){return s(t)}).style("stroke","grey").style("stroke-width",1).style("fill","white").style("fill-opacity",0),o.selectAll(".Pak_prov").data(v).enter().append("path").classed("PakProv",!0).attr("d",function(t,e){return s(t)}).style("stroke","grey").style("stroke-width",.25).style("fill","white").style("fill-opacity",0);var g=function(t,e,a,r,n){for(var s=t.length,l=e.length,o=[],i=[],c=0;c<s;c++){var d=t[c];o[d[a]]=d}for(var p=0;p<l;p++){var u=e[p],y=o[u[r]];i.push(n(u,y))}return i}(u,elections_2013,"Seat","seat",function(t,e){return{seat:e.Seat,PrimaryDistrict:e.PrimaryDistrict,SeconDistrict:e.SeconDistrict,Province:e.Province,"Percentage of Votes Polled to Registered Voters":t["Percentage of Votes Polled to Registered Voters"],"Registered Votes":t["Registered Votes"],"Rejected Votes":t["Rejected Votes"],"Valid Votes":t["Valid Votes"],"Votes Polled":t["Votes Polled"],results:t.results}}),k=d3.nest().key(function(t){return t.PrimaryDistrict}).entries(g),P=k.map(function(t){return t.key}),V=k.map(function(t,e){return{key:t.key,values:(a=t.values,r="results",n=[],a.forEach(function(t,e){var a=Object.keys(t);t[r].forEach(function(e){a.forEach(function(a){a!=r&&(e[a]=t[a])}),n.push(e)})}),n)};var a,r,n}).map(function(t,e){return{key:t.key,values:d3.nest().key(function(t){return t.party}).rollup(function(t){return d3.sum(t,function(t){return t.votes})}).entries(t.values).sort(function(t,e){return e.value-t.value})}}),w=_.keyBy(V,"key"),x=_.keyBy(k,"key"),A="Pakistan Tehreek-e-Insaf";function b(t,e){var a=t.values.map(function(t){return t.results}).map(function(t){return t.filter(function(t){return t.party==e})});return a=[].concat.apply([],a).filter(function(t){return null!=t}).map(function(t){return t.votes})}function S(t){return t.values.map(function(t){return t["Valid Votes"]})}var j=d3.scaleSqrt().domain([0,100]).range([0,15]),D=d3.scaleSqrt().domain([0,21]).range([0,69]);l.selectAll("circle").data(k).enter().append("circle").attr("cx",function(t){return X(t.key)[0]}).attr("cy",function(t){return X(t.key)[1]}).style("fill",function(e){return t(A)}).style("fill-opacity",.7).each(function(t,e){var a=b(t,A),r=S(t);t.ValidVotesTotal=d3.sum(r),t.VotePerc=d3.sum(a)/d3.sum(r)*100,t.VotePerc=Math.round(10*t.VotePerc)/10}).attr("r",function(t,e){return j(t.VotePerc)}).attr("class",function(t){return"votePerc "+t.key}).attr("id",function(t){return i(t.key)});var B=k,T=d3.voronoi().x(function(t){return X(t.key)[0]+2*Math.random()-1}).y(function(t){return X(t.key)[1]+2*Math.random()-1}).extent([[0,0],[a,r]]);l.append("defs").selectAll(".clip.cartogram").data(T.polygons(B)).enter().append("clipPath").attr("class","clip cartogram").attr("id",function(t){return"clipCartogram"+i(t.data.key)}).append("path").attr("class","clip-path-circle cartogram").attr("d",function(t){return"M"+t.join(",")+"Z"}),l.append("g").classed("clip-circles",!0).classed("cartogram",!0).selectAll(".circle-catcher.cartogram").data(B).enter().append("circle").attr("class",function(t,e){return"circle-catcher cartogram "+t.key}).attr("clip-path",function(t,e){return"url(#clipCartogram"+i(t.key)+")"}).style("clip-path",function(t,e){return"url(#clipCartogram"+i(t.key)+")"}).attr("cx",function(t){return X(t.key)[0]}).attr("cy",function(t){return X(t.key)[1]}).attr("r",20).style("fill","none").style("pointer-events","all"),l.selectAll("circle.circle-catcher.cartogram").on("mouseover",function(e,a){var r=d3.select(this).attr("class").replace("circle-catcher cartogram ",""),n=d3.select(".votePerc#"+i(r));n.transition("districtSelectTrans").duration(100).style("stroke","black").style("stroke-width",1);var s=d3.select(this).data()[0],o=s.key,c=i(s.key),d=s.values.map(function(t){return t.SeconDistrict});d=d.map(function(t){return t.split(" - ")});var p=(d=[].concat.apply([],d)).filter(function(t){return""!=t});d=p.map(function(t){return i(t)});var u=x[e.key].values.length,y=x[e.key].values.map(function(t){return+t.seat.replace("NA-","")}),f=d3.min(y),h=d3.max(y),v=x[e.key].values.map(function(t){return t.results[0].party}),m=0;v.forEach(function(t){t===A&&m++});var g=w[o].values[0].key,k=0;v.forEach(function(t){t===g&&k++}),l.append("circle").attr("r",0).attr("cx",X(e.key)[0]).attr("cy",X(e.key)[1]).style("fill","none").style("stroke","#212121").style("stroke-width",.5).style("stroke-dasharray",2).classed("seatBubble",!0).transition("seatBubbleTrans").attr("r",D(u)).style("stroke-width",2),d3.select("body").append("div").classed("animated",!0).classed("fadeIn",!0).classed("cartogramtool",!0).attr("id","hoverbox");var V,b=d3.select(".cartogramtool");if(b.append("div").classed("cartotoolhead",!0).html(function(t){return'<span>District: <span style="color: #283593">'+o+'</span></span><span>Valid Votes: <span style="color: #283593">'+s.ValidVotesTotal+"</span></span>"}),b.append("div").classed("cartotoolop",!0).html(function(t){var e=p.join(" | ");return""==e?'<span style="color: #283593">Other districts: None</span>':'<span style="font-size: 11px">Other districts: '+e+"</span>"}),b.append("div").classed("cartotoolfooter",!0).html(function(t){return f===h?"<span>Total seats: "+u+"</span><span>NA"+f+"</span>":"<span>Total seats: "+u+"</span><span>NA"+f+" - NA"+h+"</span>"}),b.append("div").classed("cartotoolparty",!0).style("background",d3.rgb(t(A)).darker(1)).html(function(t){return'<span class="cartotoolpartyhead">SELECTED PARTY</span>'}),b.append("div").classed("cartotoolparty",!0).style("background",d3.rgb(t(w[o].values[0].key)).darker(1)).html(function(t){return'<span class="cartotoolpartyhead">MAJORITY VOTE</span>'}),b.append("div").classed("cartotoolpartylogo",!0).html(image(A)),b.append("div").classed("cartotoolpartylogo",!0).html(image(w[o].values[0].key)),b.append("div").classed("cartotoolpartydetail",!0).html(function(t){return"<span>Party: "+abbreviate(A)+"</span>"}),b.append("div").classed("cartotoolpartydetail",!0).html(function(t){return"<span>Party: "+abbreviate(w[o].values[0].key)+"</span>"}),b.append("div").classed("cartotoolpartydetail",!0).html(function(t){return"<span>Vote share: "+s.VotePerc+"%</span>"}),b.append("div").classed("cartotoolpartydetail",!0).html(function(t){var e=w[o].values[0].value,a=e/s.ValidVotesTotal*100;return"<span>Vote share: "+Math.round(10*a)/10+"%</span>"}),b.append("div").classed("cartotoolpartydetail",!0).html(function(t){return"<span>Seats Won: "+m+"</span>"}),b.append("div").classed("cartotoolpartydetail",!0).html(function(t){return"<span>Seats Won: "+k+"</span>"}),d3.event.pageY>=460){var S=document.getElementById("hoverbox");b.style("top",d3.event.pageY-S.offsetHeight-18+"px"),d3.event.pageX-125<0?b.style("left",window.innerWidth/2-125+"px"):d3.event.pageX+125>window.innerWidth?b.style("left",window.innerWidth/2-125+"px"):window.innerWidth<450?b.style("left",window.innerWidth/2-125+"px"):b.style("left",d3.event.pageX-125+"px")}else b.style("top",d3.event.pageY+14+"px"),d3.event.pageX-125<0?b.style("left",window.innerWidth/2-125+"px"):d3.event.pageX+125>window.innerWidth?b.style("left",window.innerWidth/2-125+"px"):window.innerWidth<450?b.style("left",window.innerWidth/2-125+"px"):b.style("left",d3.event.pageX-125+"px");d3.selectAll("path."+c).raise(),d3.selectAll("path."+c).transition().duration(100).style("stroke","purple").style("stroke-width",1.5);var j=d.length;V=1==j?"path."+d[0]:j>1?d.reduce(J):"nothing",d3.selectAll(V).raise(),d3.selectAll(V).transition().duration(100).style("stroke","purple").style("fill",function(t){return P.indexOf(t.properties.districts)>-1?"#BDBDBD":"none"}).style("stroke-width",1.5)}),l.selectAll("circle.circle-catcher.cartogram").on("mouseout",function(t,e){var a,r=d3.select(this).attr("class").replace("circle-catcher cartogram ",""),n=d3.select(".votePerc#"+i(r)),s=d3.select(this).data()[0],l=i(s.key),o=s.values.map(function(t){return t.SeconDistrict});o=o.map(function(t){return t.split(" - ")}),o=(o=(o=[].concat.apply([],o)).filter(function(t){return""!=t})).map(function(t){return i(t)}),n.transition("districtSelectTrans").duration(100).style("stroke","black").style("stroke-width",0),d3.selectAll(".cartogramtool").remove(),d3.select(".seatBubble").remove(),d3.selectAll("path."+l).transition().duration(100).style("stroke","none").style("stroke-width",0);var c=o.length;a=1==c?"path."+o[0]:c>1?o.reduce(J):"nothing",d3.selectAll(a).transition().duration(100).style("stroke","none").style("stroke-width",0).style("fill","none").style("opacity",1)}),$(".cartinput").click(function(){var e;A=d3.select(this).attr("value"),e=A,d3.selectAll("circle.votePerc").each(function(t,a){var r=b(t,e),n=S(t);t.ValidVotesTotal=d3.sum(n),t.VotePerc=d3.sum(r)/d3.sum(n)*100,t.VotePerc=Math.round(10*t.VotePerc)/10}).transition("partySwitchTrans").duration(1e3).attr("r",function(t,e){return j(t.VotePerc)}).style("fill",function(a){return t(e)})});var M=d3.select("#legendcontain"),L=(W=d3.range(20,101,20)).map(function(t){return j(t)}),W=W.map(function(t){return t+"%"}),z=d3.scaleOrdinal().domain(W).range(L),N=M.append("div").classed("voteShrLegDiv",!0);N.append("p").text("Vote Share").style("font-size","12px").style("text-align","center").style("margin-bottom","1px");var O=N.append("svg").classed("voteShrLegSVG",!0).attr("width",220).attr("height",90);O.append("g").attr("class","voteShrLegG").attr("transform","translate(25, 29)");var C=d3.legendSize().scale(z).shape("circle").shapePadding(20).labelOffset(15).orient("horizontal");O.select(".voteShrLegG").call(C),d3.selectAll(".voteShrLegSVG text").style("font-size","10px"),d3.selectAll(".voteShrLegSVG circle").style("fill","none").style("stroke","black");var E=d3.range(1,6,1),G=E.map(function(t){return D(t)}),R=d3.scaleOrdinal().domain(E).range(G),F=M.append("div").classed("seatLegDiv",!0).style("max-width","350px").style("min-width","300px");F.append("p").text("Number of Seats").style("font-size","12px").style("text-align","center").style("margin-bottom","1px");var I=F.append("svg").classed("seatLegSVG",!0).attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 350 90");I.append("g").attr("class","seatLegG").attr("transform","translate(25, 20)");var Y=d3.legendSize().scale(R).shape("circle").shapePadding(25).labelOffset(15).orient("horizontal");function X(t){return m.filter(function(e){return e.district==t})[0].centroid}function J(t,e,a,r){return a==r.length?t+",path."+e:1==a?"path."+t+",path."+e:t+",path."+e}I.select(".seatLegG").call(Y),d3.selectAll(".seatLegSVG text").style("font-size","10px"),d3.selectAll(".seatLegSVG circle").style("fill","none").style("stroke","black").style("stroke-width",2).style("stroke-dasharray",2)})}()}
